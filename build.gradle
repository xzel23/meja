plugins {
  id "com.github.spotbugs" version "1.6.1"
  id "com.jfrog.bintray" version "1.8.0"
  id "com.dua3.gradle.jpms" version "0.3.1"
}

apply plugin: 'maven'
apply plugin: 'maven-publish'
apply plugin: 'java-library'
apply plugin: 'com.github.spotbugs'
apply plugin: 'com.dua3.gradle.jpms'
apply plugin: 'eclipse'

/////////////////////////////////////////////////////////////////////////////
    group              = 'com.dua3.meja'
    version            = '1.0-rc1'
    
    ext.moduleName     = project.group 
    ext.scm            = 'https://github.com/xzel23/meja.git'
    ext.repo           = 'public'
    ext.description    = 'meja spreadsheet library'
    
    ext.developerId    = 'xzel23'
    ext.developerName  = 'Axel Howind'
    ext.developerEmail = 'axel@dua3.com'

    sourceSets {
        main    { java.srcDirs 'src/main/java'    }
        
        swing   { java.srcDirs 'src/swing/java'   }
        
        samples { java.srcDirs 'src/samples/java' }
    }
    
/////////////////////////////////////////////////////////////////////////////

// remove module-info.java from eclipse source folder
eclipse.classpath.file.whenMerged {
    for (item in entries.findAll{ it.path.matches('src/[^/]+/java') }) {
    	item.excludes += 'module-info.java'
    }
}

repositories {
    mavenLocal()
    jcenter()
    maven { url  "https://dl.bintray.com/dua3/public" }
}

dependencies {
    // Apache POI
    def poiVersion = "3.17"
    compile "org.apache.poi:poi:${poiVersion}"
    compile "org.apache.poi:poi-ooxml:${poiVersion}"
    compile "org.apache.poi:poi-ooxml-schemas:${poiVersion}"

    // dua3 utility
    compile        group: 'com.dua3.utility', name: 'utility', version: '0.16.0'
    swingCompile   group: 'com.dua3.utility', name: 'utility', version: '0.16.0'
    samplesCompile group: 'com.dua3.utility', name: 'utility', version: '0.16.0'
    
    // JUnit    
    testCompile "junit:junit:4.12"

    swingCompile   sourceSets.main.output
    samplesCompile sourceSets.main.output, sourceSets.swing.output
    runtime sourceSets.main.output, sourceSets.swing.output, sourceSets.samples.output
}

sourceCompatibility = 8
targetCompatibility = 8

// === SPOTBUGS === >

spotbugs.toolVersion = '3.1.3'

tasks.withType(com.github.spotbugs.SpotBugsTask) {
    reports {
        xml.enabled false
        html.enabled true
    }
}

// === ARTIFACTS === >

for (SourceSet sourceSet: sourceSets) {
    def name = sourceSet.name
    
    def jarName = "jar_$name"
    def sourcesJarName = "sourcesJar_$name"
                
    def suffix = name.equals("main") ? "" : "-$name"
    def base= "meja$suffix" 
        
    task "$jarName"(type: Jar, dependsOn: classes) {
        classifier null
        baseName base
        from sourceSet.output
    }
    
    task "$sourcesJarName"(type: Jar, dependsOn: classes) {
        classifier 'sources'
        baseName base
        from sourceSet.allSource
    }
}

task javadocJar(type: Jar, dependsOn: javadoc) {
    classifier 'javadoc'
    from javadoc.destinationDir
}    

// === MAVEN publication === >

// Create the pom configuration:
def pomConfig = {
    licenses {
        license {
            name "The Apache Software License, Version 2.0"
            url "http://www.apache.org/licenses/LICENSE-2.0.txt"
        }
    }
    developers {
        developer {
            id    project.developerId
            name  project.developerName
            email project.developerEmail
        }
    }
    
    scm {
       url project.scm
    }
}

// Create the publication with the pom configuration:
publishing {
    publications {
        for (SourceSet sourceSet: sourceSets) {
            def name = sourceSet.name
            
            if (name.equals("test"))
                break
        
            def suffix = name.equals("main") ? "" : "-$name"
            def pubName= "meja$suffix"
             
            "$pubName"(MavenPublication) {
                def jarName = "jar_$name"
                def sourcesJarName = "sourcesJar_$name"
                def javadocJarName = "javadocJar_$name"
                                                    
                artifact tasks."$jarName"      
                artifact tasks."$sourcesJarName"
                
                if (name.equals("main"))  
                    artifact javadocJar       

                groupId project.group
                artifactId pubName
                version version
                pom.withXml {
                    def root = asNode()
                    root.appendNode('description', project.description)
                    root.appendNode('name', pubName)
                    root.appendNode('url', project.scm)
                    root.children().last() + pomConfig
                }
            }
        }
    }
}

// === BINTRAY === >

bintray {
    user = findProperty('BINTRAY_USER') ?: 'NONE'
    key = findProperty('BINTRAY_KEY') ?: 'NONE'

    configurations = ['archives']

    dryRun = false //[Default: false] Whether to run this as dry-run, without deploying
    publish = false //[Default: false] Whether version should be auto published after an upload    
    override = false //[Default: false] Whether to override version artifacts already published    

    pkg {
        repo = project.repo
        name = project.group
        userOrg = findProperty('BINTRAY_USER_ORG') ?: 'NONE'
        licenses = ['Apache-2.0']
        vcsUrl = project.scm

        version {
            name = project.version
            desc = project.name+version
            released  = new Date()
            vcsTag = project.version
        }
    }

    // publish everything    
    def publicationList = []
    for (SourceSet sourceSet: sourceSets) {
        def name = sourceSet.name
        
        if (name.equals("test"))
            break
    
        def suffix = name.equals("main") ? "" : "-$name"
        def pubName= "meja$suffix"
         
        publicationList.add("$pubName")
    }
    publications = publicationList
}

// === DEFAULT TASKS === >

defaultTasks 'build', 'publishToMavenLocal', 'install'
